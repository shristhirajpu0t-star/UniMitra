const express = require("express");
const cors = require("cors");
const multer = require("multer");
const fs = require("fs");
const path = require("path");
const { extractText } = require("./extractText"); // keep this if you have extraction

const app = express();
const PORT = 5001;

app.use(cors());
app.use(express.json());
app.use(express.urlencoded({ extended: true }));
app.use(express.static("public"));

app.get("/", (req, res) => {
  res.sendFile(path.join(__dirname, "public", "index.html"));
});

const uploadFolder = path.join(__dirname, "uploads");
if (!fs.existsSync(uploadFolder)) fs.mkdirSync(uploadFolder);

const storage = multer.diskStorage({
  destination: (req, file, cb) => cb(null, uploadFolder),
  filename: (req, file, cb) => cb(null, Date.now() + "-" + file.originalname)
});
const upload = multer({ storage });

const dataFile = path.join(__dirname, "documents.json");
let documents = [];
if (fs.existsSync(dataFile)) {
  try { documents = JSON.parse(fs.readFileSync(dataFile, "utf-8")); } 
  catch(e){ documents=[]; }
}

app.get("/documents", (req,res)=>res.json(documents));
app.get("/download/:filename", (req,res)=>{
  const filepath = path.join(uploadFolder, req.params.filename);
  if (!fs.existsSync(filepath)) return res.status(404).send("File not found");
  res.download(filepath);
});

app.post("/upload", upload.single("file"), async (req,res)=>{
  try {
    const { title, type, semester, course, subject, content } = req.body;
    let finalContent = content?.trim() || "";

    if (req.file) {
      const filePath = path.join(uploadFolder, req.file.filename);
      try {
        let extracted = await extractText(filePath, req.file.mimetype);
        if (!extracted || extracted.trim()==="") {
          // If extraction fails, fallback to auto-generated content
          extracted = Document "${title}" uploaded.\nType: ${type}\nSubject: ${subject}\nCourse: ${course}\nSemester: ${semester}.;
        }
        finalContent = finalContent || extracted;
      } catch(e){
        // Extraction error fallback
        finalContent = finalContent || Document "${title}" uploaded.\nType: ${type}\nSubject: ${subject}\nCourse: ${course}\nSemester: ${semester}.;
      }
    }

    if (!title || !type || !semester || !course || !subject)
      return res.status(400).json({error:"All fields are required"});

    const newDoc = {
      id: Date.now().toString(),
      title,
      type,
      semester,
      course,
      subject,
      content: finalContent,
      filename: req.file ? req.file.filename : null,
      uploadedAt: new Date().toISOString()
    };

    documents.push(newDoc);
    fs.writeFileSync(dataFile, JSON.stringify(documents, null,2));
    res.json({success:true, doc:newDoc});

  } catch(err){
    console.error(err);
    res.status(500).json({error:"Upload failed"});
  }
});

app.listen(PORT,()=>console.log(âœ… UniMitra backend running at http://localhost:${PORT}));